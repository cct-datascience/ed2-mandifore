---
title: "R Notebook"
output: html_document
---

Plots

-   One elasticisity lolipop plot for each ecosystem with CI around point

-   Variance decomposition can't be combined

Try making SA plots for transpiration and npp post hoc

-   Edit settings_checked.xml and re-run sensitivity analysis part of workflow.R

Next steps:

-   Prototype code to wrangle sensitivity output

## Get all the data

```{r}
library(fs)
library(tidyverse)
library(ggdist)
library(tidync)
library(lubridate)
library(furrr)
library(future.callr)
library(units)

plan(callr, workers = 3)
theme_set(theme_bw())
```

```{r}
base_path <- "/data/output/pecan_runs/transect"
sites <- dir_ls(base_path, recurse = 1, regexp = "mixed$|prairie$|pine$")
```

Get all the data

```{r}
sa_output <-
  map(sites, \(.x) {
    sa_results <- .x |> 
      dir_ls(regexp = "sensitivity\\.results") 
    if(length(sa_results)==1) {
      load(sa_results)
      sensitivity.results$SetariaWT2$variance.decomposition.output |>
        bind_rows(.id = "x") |>
        pivot_longer(-x, names_to = "trait") |>
        pivot_wider(names_from = x, values_from = value)
    }
  }) |> 
  bind_rows(.id = "dir") |> 
  mutate(
    ecosystem = dir |> path_split() |> map_chr(7),
         site = dir |> path_split() |> map_chr(6)
    ) |> 
  select(site, ecosystem, everything()) |>
  select(-dir) |> 
  mutate(trait = case_when(
    trait == "leaf_turnover_rate"   ~ "Leaf turnover rate",
    trait == "nonlocal_dispersal"   ~ "Seed dispersal",
    trait == "fineroot2leaf"        ~ "Fine root allocation",
    trait == "root_turnover_rate"   ~ "Root turnover rate",
    trait == "seedling_mortality"   ~ "Seedling mortality",
    trait == "stomatal_slope"       ~ "Stomatal slope",
    trait == "quantum_efficiency"   ~ "Quantum efficiency",
    trait == "Vcmax"                ~ "Vcmax",
    trait == "r_fract"              ~ "Reproductive allocation",
    trait == "cuticular_cond"       ~ "Cuticular conductance",
    trait == "SLA"                  ~ "Specific leaf area",
    TRUE ~ trait
  ))


sa_output |> 
  mutate(site = str_remove(site, "MANDIFORE-SEUS-")) |> 
  ggplot(aes(x = elasticities, y = trait)) +
  geom_point() +
  geom_segment(aes(xend = elasticities, x = 0, y = trait, yend = trait)) +
  facet_grid(ecosystem~site, labeller = label_both) +
  theme_bw()
```

Average across 9 sites and plot mean ± SE ?

```{r}
sem <- function(x) {
  sd(x) / sqrt(length(x))
}

sa_summary <- 
  sa_output |>
  group_by(ecosystem, trait) |> 
  summarize(across(c("coef.vars", "elasticities", "sensitivities"), .fns = list("mean" = mean, "SE" = sem)))

ggplot(sa_summary, aes(y = trait)) +
  geom_pointinterval(
    aes(
      x = elasticities_mean,
      xmin = elasticities_mean - elasticities_SE,
      xmax = elasticities_mean + elasticities_SE
    )
  ) +
  geom_vline(xintercept = 0, alpha = .5, linetype = 3) +
  facet_grid(~ecosystem, scales = "free") +
  labs(caption = "means ± SE for 9 sites (eventually)", x = "Elasticity", y="")
```

## Timeseries plots

Wrangle data one ensemble at a time and write to disk as one .csv per ensemble. This will allow `arrow` to open the data as a partitioned .csv file which is very fast to work with. Each .csv file needs to be in the ensemble directory and only needs to contain the data. Site, ecosystem, and ensemble will be inferred from directory structure.


```{r}
ensembles <- dir_ls(path(sites, "out"), regexp = "ENS-")

#TODO, move to R/, document
write_run_csv <- function(ensemble, overwrite = FALSE) {
  if(file_exists(path(ensemble, "run_data.csv"))) {
    if(overwrite) {
      warning("Overwriting run_data.csv")
    } else {
      warning("run_data.csv already exists")
      return(path(ensemble, "run_data.csv"))
    }
  }
  
  nc_files <- ensemble |>
    dir_ls(glob = "*.nc") 
  
  #check that nc_files exist
  if(length(nc_files) == 0) {
    warning("No .nc files found!")
    return(NA)
  }
  
  nc_files|> 
    map(\(nc_file) {
      tidync(nc_file) |> 
        activate("D0,D1,D2,D3") |> 
        hyper_tibble() |> 
        # get data from file name into tibble
        mutate(
          ensemble = path_split(nc_file) |> map_chr(-2),
          ecosystem = path_split(nc_file) |> map_chr(-4),
          site = path_split(nc_file) |> map_chr(-5),
          year = path_file(nc_file) |> str_remove("\\.nc"),
          date = (make_date(year, month = 1, day = 1) + days(dtime)) |>
            # I don't think PEcAn knows about leap years
            floor_date(unit = "month")
        ) |> 
        select(-dtime, -year)
    }) |> bind_rows() |> 
    write_csv(path(ensemble, "run_data.csv"))
  return(path(ensemble, "run_data.csv"))
}


paths <- 
  map_chr(ensembles, \(x) write_run_csv(x, overwrite = FALSE), .progress = TRUE) |>
  discard(is.na) 

```

Read csv files in

```{r}
ens_data_raw <- 
  read_csv(paths)

ens_plot_df <- 
  ens_data_raw |> 
  group_by(site, lat, ecosystem, date, pft) |> 
  summarize(across(c(AGB_PFT, NPP_PFT, TRANSP_PFT, DENS),
                   .fns = list(
                     "median" = median,
                     "lower" = ~quantile(., 0.25),
                     "upper" = ~quantile(., 0.75)
                   )), .groups = "drop") |> 
  arrange(desc(lat)) |> 
  mutate(lat = round(lat, 2) |> as.character() |> fct_inorder(),
         site = str_remove(site, "MANDIFORE-SEUS-"),
         pft_name = case_when(
           pft==1  ~ "SetariaWT",
           pft==7  ~ "Southern_pine",
           pft==10 ~  "South_Mid_Hardwood",
           pft==8  ~ "Evergreen_Hardwood",
           pft==5  ~ "c3grass",
           pft==16 ~  "c4grass",
           pft==12 ~  "forb"
         ))
# add units
units::install_unit("plants", def = "unitless")
ens_plot_df <- 
  ens_plot_df |> 
  mutate(
    across(starts_with("AGB_PFT_"), \(x) set_units(x, "kg/m^2")),
    across(starts_with("NPP_PFT_"), \(x) set_units(x, "kg/m^2/s")),
    across(starts_with("TRANSP_PFT_"), \(x) set_units(x, "kg/m^2/s")),
    across(starts_with("DENS_"), \(x) set_units(x, "plants/m^2"))
  )
```

Make and save plots

```{r}
p_dens <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = DENS_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = DENS_lower, ymax = DENS_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Density", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "dens.png"), p_dens)

p_dens_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = DENS_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = DENS_lower, ymax = DENS_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Density", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "dens_setaria.png"), p_dens_setaria)

p_agb <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = AGB_PFT_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = AGB_PFT_lower, ymax = AGB_PFT_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "AGB", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "agb.png"), p_agb)

p_agb_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = AGB_PFT_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = AGB_PFT_lower, ymax = AGB_PFT_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "AGB", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "agb_setaria.png"), p_agb_setaria)

p_npp <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = NPP_PFT_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = NPP_PFT_lower, ymax = NPP_PFT_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "NPP", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "npp.png"), p_npp)

p_npp_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = NPP_PFT_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = NPP_PFT_lower, ymax = NPP_PFT_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "NPP", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "npp_setaria.png"), p_npp_setaria)

p_transp <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = TRANSP_PFT_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = TRANSP_PFT_lower, ymax = TRANSP_PFT_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Transpiration", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "transp.png"), p_transp)

p_transp_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = TRANSP_PFT_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = TRANSP_PFT_lower, ymax = TRANSP_PFT_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Transpiration", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "transp_setaria.png"), p_transp_setaria)

```
