---
title: "MSR plots for April"
output: html_document
---

```{r setup}
library(fs)
library(tidyverse)
library(ggdist)
library(tidync)
library(lubridate)
library(furrr)
library(future.callr)
library(units)

plan(callr, workers = 3)
theme_set(theme_bw())

# define util functions

## Standard Error of the Mean
sem <- function(x) {
  sd(x) / sqrt(length(x))
}

source(here::here("R", "write_run_csv.R"))
```

## Sensitivity Analysis

```{r}
base_path <- "/data/output/pecan_runs/transect"
sites <- dir_ls(base_path, recurse = 1, regexp = "mixed$|prairie$|pine$")
```

Collect all the sensitivity analysis results from the .Rdata files.  Requires dumping list of dataframes into environment, row-binding them, and doing some wrangling.

```{r}
sa_output <-
  map(sites, \(.x) {
    sa_results <- .x |> 
      dir_ls(regexp = "sensitivity\\.results") 
    if(length(sa_results)==1) {
      load(sa_results)
      sensitivity.results$SetariaWT2$variance.decomposition.output |>
        bind_rows(.id = "x") |>
        pivot_longer(-x, names_to = "trait") |>
        pivot_wider(names_from = x, values_from = value)
    }
  }) |> 
  bind_rows(.id = "dir") |> 
  mutate(
    ecosystem = dir |> path_split() |> map_chr(7),
         site = dir |> path_split() |> map_chr(6)
    ) |> 
  select(site, ecosystem, everything()) |>
  select(-dir) |> 
  mutate(trait = case_when(
    trait == "leaf_turnover_rate"   ~ "Leaf turnover rate",
    trait == "nonlocal_dispersal"   ~ "Seed dispersal",
    trait == "fineroot2leaf"        ~ "Fine root allocation",
    trait == "root_turnover_rate"   ~ "Root turnover rate",
    trait == "seedling_mortality"   ~ "Seedling mortality",
    trait == "stomatal_slope"       ~ "Stomatal slope",
    trait == "quantum_efficiency"   ~ "Quantum efficiency",
    trait == "Vcmax"                ~ "Vcmax",
    trait == "r_fract"              ~ "Reproductive allocation",
    trait == "cuticular_cond"       ~ "Cuticular conductance",
    trait == "SLA"                  ~ "Specific leaf area",
    TRUE ~ trait
  ))
```


### Plot of every site

```{r}
sa_output |> 
  mutate(site = str_remove(site, "MANDIFORE-SEUS-")) |> 
  ggplot(aes(x = elasticities, y = trait)) +
  geom_point() +
  geom_segment(aes(xend = elasticities, x = 0, y = trait, yend = trait)) +
  facet_grid(ecosystem~site, labeller = label_both) +
  theme_bw()
```

Most site-to-site variation is in prairie.  Most trait variation is in seedling mortality it looks like.

### Average across 9 sites and plot mean ± SE

```{r}
sa_summary <- 
  sa_output |>
  group_by(ecosystem, trait) |> 
  summarize(across(c("coef.vars", "elasticities", "sensitivities"), .fns = list("mean" = mean, "SE" = sem)))

ggplot(sa_summary, aes(y = trait)) +
  geom_pointinterval(
    aes(
      x = elasticities_mean,
      xmin = elasticities_mean - elasticities_SE,
      xmax = elasticities_mean + elasticities_SE
    )
  ) +
  geom_vline(xintercept = 0, alpha = .5, linetype = 3) +
  facet_grid(~ecosystem, scales = "free") +
  labs(caption = "Means ± SE for 9 sites", x = "Elasticity", y="", title = "Above Ground Biomass Elasticity Analysis")

ggsave("elasticities.png")
```

## Timeseries plots

Wrangle data one ensemble at a time and write to disk as one .csv per ensemble.

```{r}
ensembles <- dir_ls(path(sites, "out"), regexp = "ENS-")

paths <- 
  map_chr(ensembles, \(x) write_run_csv(x, overwrite = FALSE), .progress = TRUE) |>
  discard(is.na) 
```

Read csv files in and wrangle for plotting.

```{r}
ens_data_raw <- 
  read_csv(paths)

ens_plot_df <- 
  ens_data_raw |> 
  group_by(site, lat, ecosystem, date, pft) |> 
  summarize(across(c(AGB_PFT, NPP_PFT, TRANSP_PFT, DENS),
                   .fns = list(
                     "median" = median,
                     "lower" = ~quantile(., 0.25),
                     "upper" = ~quantile(., 0.75)
                   )), .groups = "drop") |> 
  arrange(desc(lat)) |> 
  mutate(lat = round(lat, 2) |> as.character() |> fct_inorder(),
         site = str_remove(site, "MANDIFORE-SEUS-"),
         pft_name = case_when(
           pft==1  ~ "Setaria",
           pft==7  ~ "Southern Pine",
           pft==10 ~ "Mid-successional Hardwood",
           pft==8  ~ "Evergreen Hardwood",
           pft==5  ~ "C3 Grass",
           pft==16 ~  "C4 Grass",
           pft==12 ~  "Forb"
         ))
# add units
units::install_unit("plants", def = "unitless")
ens_plot_df <- 
  ens_plot_df |> 
  mutate(
    across(starts_with("AGB_PFT_"), \(x) set_units(x, "kg/m^2")),
    #convert from PEcAn standard to more relatable units for plotting
    across(starts_with("NPP_PFT_"), \(x) set_units(x, "kg/m^2/s") |>
             set_units("g/m^2/month")),
    across(starts_with("TRANSP_PFT_"), \(x) set_units(x, "kg/m^2/s") |>
             set_units("g/m^2/month")),
    across(starts_with("DENS_"), \(x) set_units(x, "plants/m^2"))
  )
```

Make and save timeseries plots for all output variables.  One plot with all PFTs and one with just SetariaWT

```{r}
p_dens <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = DENS_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = DENS_lower, ymax = DENS_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Density", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "dens.png"), p_dens)

p_dens_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = DENS_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = DENS_lower, ymax = DENS_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Density", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "dens_setaria.png"), p_dens_setaria)

p_agb <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = AGB_PFT_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = AGB_PFT_lower, ymax = AGB_PFT_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "AGB", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "agb.png"), p_agb)

p_agb_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = AGB_PFT_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = AGB_PFT_lower, ymax = AGB_PFT_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "AGB", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "agb_setaria.png"), p_agb_setaria)

p_npp <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = NPP_PFT_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = NPP_PFT_lower, ymax = NPP_PFT_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "NPP", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "npp.png"), p_npp)

p_npp_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = NPP_PFT_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = NPP_PFT_lower, ymax = NPP_PFT_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "NPP", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "npp_setaria.png"), p_npp_setaria)

p_transp <-
  ens_plot_df |> 
  # filter(pft == 1) |> 
  ggplot(aes(x = date, y = TRANSP_PFT_median)) +
  geom_line(aes(color = pft_name)) +
  geom_ribbon(aes(ymin = TRANSP_PFT_lower, ymax = TRANSP_PFT_upper, fill = pft_name),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Transpiration", x = "Simulation Time", color = "PFT", fill = "PFT")

ggsave(here::here("MSRs", "2023-04-15", "transp.png"), p_transp)

p_transp_setaria <-
  ens_plot_df |> 
  filter(pft == 1) |>
  ggplot(aes(x = date, y = TRANSP_PFT_median)) +
  geom_line() +
  geom_ribbon(aes(ymin = TRANSP_PFT_lower, ymax = TRANSP_PFT_upper),
              alpha = 0.3) +
  facet_grid(lat+site~ecosystem, labeller = label_both) +
  labs(y = "Transpiration", x = "Simulation Time")

ggsave(here::here("MSRs", "2023-04-15", "transp_setaria.png"), p_transp_setaria)

```
## End of Simulation

We also discussed a plot of AGB at the end of 10 years.  I'll take a median for 2010 at each ensemble, then average across ensembles.  Plot will show raw data (means for 2010 at each ensemble) as well as median ± IQR at each site.  (boxplot + raw data).

```{r}
library(ggdist)
library(ggtext)
df <- ens_data_raw |> 
  filter(year(date) >= 2010, pft == 1) |> 
  group_by(site, lat, ecosystem, ensemble) |> 
  summarize(AGB_2010 = median(AGB_PFT, na.rm = TRUE)) |> 
  group_by(site, lat, ecosystem) |> 
  mutate(AGB_2010 = set_units(AGB_2010, "kg/m^2")) |> 
  #remove ensembles where setaria is effectively dead
  filter(AGB_2010 > set_units(0.005, "kg/m^2"))
  
    
    
ggplot(df, aes(x = AGB_2010, y = ecosystem, fill = ecosystem)) +
  stat_slab(aes(thickness = after_stat(pdf*n)), scale = 0.7) +
  stat_dotsinterval(aes(slab_color = ecosystem), side = "bottom", scale = 0.7, .width = c(0.5, 0.95)) +
  scale_fill_brewer(palette = "Set2", aesthetics = c("fill", "slab_color")) +
  labs(
    x = "Above Ground Biomass",
    y = "",
    caption = "Distribution of median aboveground biomass (AGB) of *Setaria* in the last year of a 10 year simulation across ensembles and sites. Points represent the (binned) median value of monthly AGB across the year for individual ensemble members.  Only data where AGB is greater than 0.005 kg/m^2^ are shown. The median (point), interquartile range (thick line) and 95th percentile (thin line) are shown in black."
  ) +
  theme(
    legend.position = "none",
    plot.caption = element_textbox_simple(padding = margin(t = 10))
  )
```

